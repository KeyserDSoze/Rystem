<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Alessandro Rapiti">
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Rystem.RepositoryFramework.Abstractions - Rystem</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" disabled>
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" >
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Rystem</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Concepts</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../repository/" class="dropdown-item">Repository</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Core</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rystem/" class="dropdown-item">Rystem</a>
</li>
                                    
<li>
    <a href="../Rystem.DependencyInjection/" class="dropdown-item">Rystem.DependencyInjection</a>
</li>
                                    
<li>
    <a href="../Rystem.DependencyInjection.Web/" class="dropdown-item">Rystem.DependencyInjection.Web</a>
</li>
                                    
<li>
    <a href="../Rystem.Concurrency/" class="dropdown-item">Rystem.Concurrency</a>
</li>
                                    
<li>
    <a href="../Rystem.BackgroundJob/" class="dropdown-item">Rystem.BackgroundJob</a>
</li>
                                    
<li>
    <a href="../Rystem.Concurrency.Redis/" class="dropdown-item">Rystem.Concurrency.Redis</a>
</li>
                                    
<li>
    <a href="../Rystem.Test.XUnit/" class="dropdown-item">Rystem.Test.XUnit</a>
</li>
                                    
<li>
    <a href="../Rystem.Queue/" class="dropdown-item">Rystem.Queue</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Api</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rystem.Api/" class="dropdown-item">Rystem.Api</a>
</li>
                                    
<li>
    <a href="../Rystem.Api.Client/" class="dropdown-item">Rystem.Api.Client</a>
</li>
                                    
<li>
    <a href="../Rystem.Api.Server/" class="dropdown-item">Rystem.Api.Server</a>
</li>
                                    
<li>
    <a href="../Rystem.Api.Client.Authentication.BlazorServer/" class="dropdown-item">Rystem.Api.Client.Authentication.BlazorServer</a>
</li>
                                    
<li>
    <a href="../Rystem.Api.Client.Authentication.BlazorWasm/" class="dropdown-item">Rystem.Api.Client.Authentication.BlazorWasm</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Social Authentication</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rystem.Authentication.Social.Abstractions/" class="dropdown-item">Rystem.Authentication.Social.Abstractions</a>
</li>
                                    
<li>
    <a href="../Rystem.Authentication.Social/" class="dropdown-item">Rystem.Authentication.Social</a>
</li>
                                    
<li>
    <a href="../Rystem.Authentication.Social.Blazor/" class="dropdown-item">Rystem.Authentication.Social.Blazor</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Content</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../Rystem.Content.Abstractions/" class="dropdown-item">Rystem.Content.Abstractions</a>
</li>
                                    
<li>
    <a href="../Rystem.Content.Infrastructure.Storage.Blob/" class="dropdown-item">Rystem.Content.Infrastructure.Storage.Blob</a>
</li>
                                    
<li>
    <a href="../Rystem.Content.Infrastructure.Storage.File/" class="dropdown-item">Rystem.Content.Infrastructure.Storage.File</a>
</li>
                                    
<li>
    <a href="../Rystem.Content.Infrastructure.InMemory/" class="dropdown-item">Rystem.Content.Infrastructure.InMemory</a>
</li>
                                    
<li>
    <a href="../Rystem.Content.Infrastructure.M365.Sharepoint/" class="dropdown-item">Rystem.Content.Infrastructure.M365.Sharepoint</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Repository Framework</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Rystem.RepositoryFramework.Abstractions</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Api.Client/" class="dropdown-item">Rystem.RepositoryFramework.Api.Client</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Api.Server/" class="dropdown-item">Rystem.RepositoryFramework.Api.Server</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Cache/" class="dropdown-item">Rystem.RepositoryFramework.Cache</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.InMemory/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.InMemory</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.Azure.Cosmos.Sql/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.Azure.Cosmos.Sql</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.Azure.Storage.Blob/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.Azure.Storage.Blob</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.Azure.Storage.Table/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.Azure.Storage.Table</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.Dynamics.Dataverse/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.Dynamics.Dataverse</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.EntityFramework/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.EntityFramework</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Infrastructure.MsSql/" class="dropdown-item">Rystem.RepositoryFramework.Infrastructure.MsSql</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.MigrationTools/" class="dropdown-item">Rystem.RepositoryFramework.MigrationTools</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Web.Components/" class="dropdown-item">Rystem.RepositoryFramework.Web.Components</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Api.Client.Authentication.BlazorServer/" class="dropdown-item">Rystem.RepositoryFramework.Api.Client.Authentication.BlazorServer</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Api.Client.Authentication.BlazorWasm/" class="dropdown-item">Rystem.RepositoryFramework.Api.Client.Authentication.BlazorWasm</a>
</li>
                                    
<li>
    <a href="../Rystem.RepositoryFramework.Cache.Azure.Storage.Blob/" class="dropdown-item">Rystem.RepositoryFramework.Cache.Azure.Storage.Blob</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../Rystem.Content.Infrastructure.M365.Sharepoint/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../Rystem.RepositoryFramework.Api.Client/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                              <button id="theme-menu" aria-expanded="false" data-bs-toggle="dropdown" data-bs-display="static" aria-label="Toggle theme" class="nav-link dropdown-toggle">
                                <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                <span class="d-lg-none ms-2">Toggle theme</span>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="light" aria-pressed="false">
                                    <i class="fa-solid fa-sun fa-fw"></i>
                                    <span class="ms-2">Light</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="dark" aria-pressed="true">
                                    <i class="fa-solid fa-moon fa-fw"></i>
                                    <span class="ms-2">Dark</span>
                                    <i class="fa-solid fa-check ms-auto"></i>
                                  </button>
                                </li>
                                <li>
                                  <button class="dropdown-item d-flex align-items-center" data-bs-theme-value="auto" aria-pressed="false">
                                    <i class="fa-solid fa-circle-half-stroke fa-fw"></i>
                                    <span class="ms-2">Auto</span>
                                    <i class="fa-solid fa-check ms-auto d-none"></i>
                                  </button>
                                </li>
                              </ul>
                            </li>
                    </ul>
                </div>
            </div>
        </div>
        <script src="../js/darkmode.js"></script>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="2"><a href="#interfaces" class="nav-link">Interfaces</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#command-write-delete" class="nav-link">Command (Write-Delete)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#query-read" class="nav-link">Query (Read)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#repository-pattern-write-delete-read" class="nav-link">Repository Pattern (Write-Delete-Read)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#examples" class="nav-link">Examples</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#model" class="nav-link">Model</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#command" class="nav-link">Command</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#query" class="nav-link">Query</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#alltogether-as-repository-pattern" class="nav-link">Alltogether as repository pattern</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="2"><a href="#how-to-use-it" class="nav-link">How to use it</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#please-use-irepository-and-not-irepositorypattern" class="nav-link">Please, use IRepository and not IRepositoryPattern</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#query-and-command" class="nav-link">Query and Command</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#please-use-icommand-iquery-and-not-icommandpattern-iquerypattern" class="nav-link">Please, use ICommand, IQuery and not ICommandPattern, IQueryPattern</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#tkey-when-its-not-a-primitive" class="nav-link">TKey when it's not a primitive</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ikey-interface" class="nav-link">IKey interface</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#idefaultkey" class="nav-link">IDefaultKey</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#default-tkey-record" class="nav-link">Default TKey record</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#translation" class="nav-link">Translation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#entity-framework-examples" class="nav-link">Entity framework examples</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#business-manager" class="nav-link">Business Manager</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#example" class="nav-link">Example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-bs-level="1"><a href="#factory" class="nav-link">Factory</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h2 id="interfaces">Interfaces</h2>
<p>Based on CQRS we could split our repository pattern in two main interfaces, one for update (write, delete) and one for read.</p>
<h2 id="command-write-delete">Command (Write-Delete)</h2>
<pre><code>public interface ICommandPattern&lt;T, TKey&gt; : ICommandPattern
    where TKey : notnull
{
    Task&lt;State&lt;T, TKey&gt;&gt; InsertAsync(TKey key, T value, CancellationToken cancellationToken = default);
    Task&lt;State&lt;T, TKey&gt;&gt; UpdateAsync(TKey key, T value, CancellationToken cancellationToken = default);
    Task&lt;State&lt;T, TKey&gt;&gt; DeleteAsync(TKey key, CancellationToken cancellationToken = default);
    IAsyncEnumerable&lt;BatchResult&lt;T, TKey&gt;&gt; BatchAsync(BatchOperations&lt;T, TKey&gt; operations, CancellationToken cancellationToken = default);
}
</code></pre>
<h2 id="query-read">Query (Read)</h2>
<pre><code>public interface IQueryPattern&lt;T, TKey&gt; : IQueryPattern
    where TKey : notnull
{
    Task&lt;State&lt;T, TKey&gt;&gt; ExistAsync(TKey key, CancellationToken cancellationToken = default);
    Task&lt;T?&gt; GetAsync(TKey key, CancellationToken cancellationToken = default);
    IAsyncEnumerable&lt;IEntity&lt;T, TKey&gt;&gt; QueryAsync(IFilterExpression filter, CancellationToken cancellationToken = default);
    ValueTask&lt;TProperty&gt; OperationAsync&lt;TProperty&gt;(OperationType&lt;TProperty&gt; operation, IFilterExpression filter, CancellationToken cancellationToken = default);
}
</code></pre>
<h2 id="repository-pattern-write-delete-read">Repository Pattern (Write-Delete-Read)</h2>
<p>Repository pattern is a sum of CQRS interfaces.</p>
<pre><code>public interface IRepositoryPattern&lt;T, TKey&gt; : ICommandPattern&lt;T, TKey&gt;, IQueryPattern&lt;T, TKey&gt;, IRepositoryPattern, ICommandPattern, IQueryPattern
    where TKey : notnull
{
    Task&lt;State&lt;T, TKey&gt;&gt; InsertAsync(TKey key, T value, CancellationToken cancellationToken = default);
    Task&lt;State&lt;T, TKey&gt;&gt; UpdateAsync(TKey key, T value, CancellationToken cancellationToken = default);
    Task&lt;State&lt;T, TKey&gt;&gt; DeleteAsync(TKey key, CancellationToken cancellationToken = default);
    IAsyncEnumerable&lt;BatchResult&lt;T, TKey&gt;&gt; BatchAsync(BatchOperations&lt;T, TKey&gt; operations, CancellationToken cancellationToken = default);
    Task&lt;State&lt;T, TKey&gt;&gt; ExistAsync(TKey key, CancellationToken cancellationToken = default);
    Task&lt;T?&gt; GetAsync(TKey key, CancellationToken cancellationToken = default);
    IAsyncEnumerable&lt;IEntity&lt;T, TKey&gt;&gt; QueryAsync(IFilterExpression filter, CancellationToken cancellationToken = default);
    ValueTask&lt;TProperty&gt; OperationAsync&lt;TProperty&gt;(OperationType&lt;TProperty&gt; operation, IFilterExpression filter, CancellationToken cancellationToken = default);
}
</code></pre>
<h2 id="examples">Examples</h2>
<h2 id="model">Model</h2>
<pre><code>public class User
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Email { get; set; }
}
</code></pre>
<h2 id="command">Command</h2>
<p>Your storage class has to extend ICommand, and use it on injection</p>
<pre><code>public class UserWriter : ICommand&lt;User, string&gt;
{
    public Task&lt;State&lt;User, string&gt;&gt; DeleteAsync(string key, CancellationToken cancellationToken = default)
    {
        //delete on with DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; InsertAsync(string key, User value, CancellationToken cancellationToken = default)
    {
        //insert on DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; UpdateAsync(string key, User value, CancellationToken cancellationToken = default)
    {
        //update on DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;BatchResults&lt;User, string&gt;&gt; BatchAsync(BatchOperations&lt;User, string&gt; operations, CancellationToken cancellationToken = default)
    {
        //insert, update or delete some items on DB or storage context
        throw new NotImplementedException();
    }
}
</code></pre>
<h2 id="query">Query</h2>
<p>Your storage class has to extend IQuery, and use it on injection</p>
<pre><code>public class UserReader : IQuery&lt;User, string&gt;
{
    public Task&lt;User?&gt; GetAsync(string key, CancellationToken cancellationToken = default)
    {
        //get an item by key from DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; ExistAsync(string key, CancellationToken cancellationToken = default)
    {
        //check if an item by key exists in DB or storage context
        throw new NotImplementedException();
    }
    public IAsyncEnumerable&lt;IEntity&lt;User, string&gt;&gt; QueryAsync(IFilterExpression filter, CancellationToken cancellationToken = default)
    {
        //get a list of items by a predicate with top and skip from DB or storage context
        throw new NotImplementedException();
    }
    public ValueTask&lt;TProperty&gt; OperationAsync&lt;TProperty&gt;(OperationType&lt;TProperty&gt; operation, IFilterExpression filter, CancellationToken cancellationToken = default)
    {
        //get an items count by a predicate with top and skip from DB or storage context or max or min or some other operations
        throw new NotImplementedException();
    }
}
</code></pre>
<h2 id="alltogether-as-repository-pattern">Alltogether as repository pattern</h2>
<p>if you don't have CQRS infrastructure (usually it's correct to use CQRS when you have minimum two infrastructures one for write and delete and at least one for read).
You may choose to extend IRepository, but when you inject you have to use IRepository</p>
<pre><code>public class UserRepository : IRepository&lt;User, string&gt;, IQuery&lt;User, string&gt;, ICommand&lt;User, string&gt;
{
    public Task&lt;State&lt;User, string&gt;&gt; DeleteAsync(string key, CancellationToken cancellationToken = default)
    {
        //delete on with DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; InsertAsync(string key, User value, CancellationToken cancellationToken = default)
    {
        //insert on DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; UpdateAsync(string key, User value, CancellationToken cancellationToken = default)
    {
        //update on DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;BatchResults&lt;User, string&gt;&gt; BatchAsync(BatchOperations&lt;User, string&gt; operations, CancellationToken cancellationToken = default)
    {
        //insert, update or delete some items on DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;User?&gt; GetAsync(string key, CancellationToken cancellationToken = default)
    {
        //get an item by key from DB or storage context
        throw new NotImplementedException();
    }
    public Task&lt;State&lt;User, string&gt;&gt; ExistAsync(string key, CancellationToken cancellationToken = default)
    {
        //check if an item by key exists in DB or storage context
        throw new NotImplementedException();
    }
    public IAsyncEnumerable&lt;IEntity&lt;User, string&gt;&gt; QueryAsync(IFilterExpression filter, CancellationToken cancellationToken = default)
    {
        //get a list of items by a predicate with top and skip from DB or storage context
        throw new NotImplementedException();
    }
    public ValueTask&lt;TProperty&gt; OperationAsync&lt;TProperty&gt;(OperationType&lt;TProperty&gt; operation, IFilterExpression filter, CancellationToken cancellationToken = default)
    {
        //get an items count by a predicate with top and skip from DB or storage context or max or min or some other operations
        throw new NotImplementedException();
    }
}
</code></pre>
<h2 id="how-to-use-it">How to use it</h2>
<p>In DI you install the service. Here an example on how to set a custom storage,
prepare a translation (to translate name of your properties for query during filtering),
and AddBusiness for your integration. Furthermore you may use the factory integration from Rystem.</p>
<pre><code>var factoryName = "storage";
 services.AddRepository&lt;AppUser, AppUserKey&gt;(builder =&gt;
{
    builder.SetStorage&lt;AppUserStorage&gt;(factoryName);
    builder.Translate&lt;User&gt;()
        .With(x =&gt; x.Id, x =&gt; x.Identificativo)
        .With(x =&gt; x.Username, x =&gt; x.Nome)
        .With(x =&gt; x.Email, x =&gt; x.IndirizzoElettronico);
    builder
        .AddBusiness()
            .AddBusinessBeforeInsert&lt;AppUserBeforeInsertBusiness&gt;()
            .AddBusinessBeforeInsert&lt;AppUserBeforeInsertBusiness2&gt;();
});
</code></pre>
<p>And you may inject the object</p>
<h1 id="please-use-irepository-and-not-irepositorypattern">Please, use IRepository and not IRepositoryPattern</h1>
<pre><code>IRepository&lt;AppUser, AppUserKey&gt; repository
</code></pre>
<h2 id="query-and-command">Query and Command</h2>
<p>In DI you install the services</p>
<pre><code>services.AddCommand&lt;AppUser, AppUserKey&gt;(...);
services.AddQuery&lt;AppUser, AppUserKey&gt;(...);
</code></pre>
<p>And you may inject the objects</p>
<h1 id="please-use-icommand-iquery-and-not-icommandpattern-iquerypattern">Please, use ICommand, IQuery and not ICommandPattern, IQueryPattern</h1>
<pre><code>ICommand&lt;AppUser, AppUserKey&gt; command
IQuery&lt;AppUser, AppUserKey&gt; query
</code></pre>
<h2 id="tkey-when-its-not-a-primitive">TKey when it's not a primitive</h2>
<p>You can use a class or record. 
Record is better in my opinion, for example, if you want to use the Equals operator from key, with record you don't check it by the refence but by the value of the properties in the record.
My key:</p>
<pre><code>public class MyKey 
{
    public int Id { get; set; }
    public int Id2 { get; set; }
}
</code></pre>
<p>the DI</p>
<pre><code>services.AddRepository&lt;User, MyKey&gt;(...);
</code></pre>
<p>and you may inject (for ICommand and IQuery is the same)</p>
<pre><code>IRepository&lt;User, MyKey&gt; repository
</code></pre>
<h2 id="ikey-interface">IKey interface</h2>
<p>You may implement the IKey interface to decide how to work with your key.
Here an example with Parse and AsString method and custom implementation with separator $.</p>
<pre><code>public class ClassicKey : IKey
{
    public string A { get; set; }
    public int B { get; set; }
    public double C { get; set; }

    public static IKey Parse(string keyAsString)
    {
        var splitted = keyAsString.Split('$');
        return new ClassicKey { A = splitted[0], B = int.Parse(splitted[1]), C = double.Parse(splitted[2]) };
    }

    public string AsString()
    {
        return $"{A}${B}${C}";
    }
}
</code></pre>
<h2 id="idefaultkey">IDefaultKey</h2>
<p>You may implement IDefaultKey if you want a simple key preconstructed parser.</p>
<pre><code>public class DefaultKey : IDefaultKey
{
    public string A { get; set; }
    public int B { get; set; }
    public double C { get; set; }
}
</code></pre>
<p>Automatically you can call AsString to receive a string composed by all properties separated by triple |, for instance {A}|||{B}|||{C}.
You can decide during startup the separator in two ways.
One with ServiceCollectionExtensions</p>
<pre><code>builder.Services.AddDefaultSeparatorForDefaultKeyInterface("$$$");
</code></pre>
<p>the other one with a static method offered by IDefaultKey interface</p>
<pre><code>IDefaultKey.SetDefaultSeparator("$$$");
</code></pre>
<h2 id="default-tkey-record">Default TKey record</h2>
<p>You may use the default record key in repository framework namespace.
It's not really useful when used with no-primitive or no-struct objects (in terms of memory usage [Heap]).
For 1 value (it's not really useful I know, but I liked to create it).</p>
<pre><code>new Key&lt;int&gt;(2);
</code></pre>
<p>or for 2 values (useful)</p>
<pre><code>new Key&lt;int, int&gt;(2, 4);
</code></pre>
<p>or for 3 values (unuseful)</p>
<pre><code>new Key&lt;int, int, string&gt;(2, 4, "312");
</code></pre>
<p>or for 4 values (useful)</p>
<pre><code>new Key&lt;int, int, double, Guid&gt;(2, 4, 3, Guid.NewGuid());
</code></pre>
<p>or for 5 values (unuseful)</p>
<pre><code>new Key&lt;int, int, string, Guid, string&gt;(2, 4, "312", Guid.NewGuid(), "3232");
</code></pre>
<p>the DI</p>
<pre><code>services.AddRepository&lt;User, Key&lt;int, int&gt;, UserRepository&gt;();
</code></pre>
<p>and you may inject (for ICommand and IQuery is the same)</p>
<pre><code>IRepository&lt;User, Key&lt;int, int&gt;&gt; repository
</code></pre>
<h2 id="translation">Translation</h2>
<p>In some cases you need to "translate" your query for your database context query, for example in case of EF integration.</p>
<pre><code>services.AddDbContext&lt;SampleContext&gt;(options =&gt;
{
    options.UseSqlServer(configuration["ConnectionString:Database"]);
}, ServiceLifetime.Scoped);
services.AddRepository&lt;AppUser, AppUserKey&gt;(repositoryBuilder =&gt;
{
    repositoryBuilder.SetStorage&lt;AppUserStorage&gt;();
    repositoryBuilder.Translate&lt;User&gt;()
        .With(x =&gt; x.Id, x =&gt; x.Identificativo)
        .With(x =&gt; x.Username, x =&gt; x.Nome)
        .With(x =&gt; x.Email, x =&gt; x.IndirizzoElettronico);
});
</code></pre>
<p>In this case I'm helping the Filter class to understand how to transform itself when used in a different context.
Use Filter methods to help to translate and apply to your context the right query.</p>
<pre><code>await foreach (var user in filter.ApplyAsAsyncEnumerable(_context.Users))
    yield return new AppUser(user.Identificativo, user.Nome, user.IndirizzoElettronico, new());
</code></pre>
<p>You may use Filter for queryable, FilterAsEnumerable for Enumerable and FilterAsAsyncEnumerable for async enumerable context.</p>
<p>You can add more translations for the same model</p>
<pre><code>services.AddDbContext&lt;SampleContext&gt;(options =&gt;
{
    options.UseSqlServer(configuration["ConnectionString:Database"]);
}, ServiceLifetime.Scoped);
services.AddRepository&lt;AppUser, AppUserKey&gt;(repositoryBuilder =&gt;
{
    repositoryBuilder.SetStorage&lt;AppUserStorage&gt;();
    repositoryBuilder.Translate&lt;User&gt;()
        .With(x =&gt; x.Id, x =&gt; x.Identificativo)
        .With(x =&gt; x.Username, x =&gt; x.Nome)
        .With(x =&gt; x.Email, x =&gt; x.IndirizzoElettronico);
    repositoryBuilder
        .AddBusiness()
            .AddBusinessBeforeInsert&lt;AppUserBeforeInsertBusiness&gt;()
            .AddBusinessBeforeInsert&lt;AppUserBeforeInsertBusiness2&gt;();
});
</code></pre>
<h2 id="entity-framework-examples">Entity framework examples</h2>
<p><a href="https://github.com/KeyserDSoze/RepositoryFramework/tree/master/src/RepositoryFramework.Test/RepositoryFramework.Test.Infrastructure.EntityFramework">Here you may find the example</a>
<a href="https://github.com/KeyserDSoze/RepositoryFramework/blob/master/src/RepositoryFramework.Test/RepositoryFramework.Test.Infrastructure.EntityFramework/AppUser.cs">Repository pattern applied</a>
<a href="https://github.com/KeyserDSoze/RepositoryFramework/blob/master/src/RepositoryFramework.Test/RepositoryFramework.UnitTest/Tests/AllIntegration/AllIntegrationTest.cs">Unit test flow</a></p>
<h1 id="business-manager">Business Manager</h1>
<p>You have the chance to write your business methods to execute them before or after a command or query.
For instance, you have to check before an update or insert the value of an entity and deny the final insert/update on the database.</p>
<h2 id="example">Example</h2>
<p>In this example BeforeInsertAsync runs before InsertAsync of IRepository/ICommand and AfterInsertAsync runs after InsertAsync of IRepository/ICommand.</p>
<pre><code>.AddRepository&lt;Animal, long&gt;(builder =&gt; {
    builder.
        WithInMemory();
    builder
        .AddBusiness()
            .AddBusinessAfterInsert&lt;AnimalBusiness&gt;()
            .AddBusinessBeforeInsert&lt;AnimalBusiness&gt;();
});
</code></pre>
<p>more interesting usage comes to move business in another project, you can add to your infrastructure in the following way</p>
<pre><code>.AddBusinessForRepository&lt;Animal, long&gt;(builder =&gt; {
    builder
        .AddBusiness()
            .AddBusinessAfterInsert&lt;AnimalBusiness&gt;()
            .AddBusinessBeforeInsert&lt;AnimalBusiness&gt;();
});
</code></pre>
<p>Then, you could have a library for infrastructure (or more than one) and a library for business to separate furthermore the concepts.</p>
<p>The animal business to inject will be the following one.</p>
<pre><code>public sealed class AnimalBusiness : IRepositoryBusinessBeforeInsert&lt;Animal, long&gt;, IRepositoryBusinessAfterInsert&lt;Animal, long&gt;
{
    public static int After;
    public Task&lt;State&lt;Animal&gt;&gt; AfterInsertAsync(State&lt;Animal, long&gt; state, Entity&lt;Animal, long&gt; entity, CancellationToken cancellationToken = default)
    {
        After++;
        return Task.FromResult(state);
    }

    public static int Before;
    public Task&lt;State&lt;Animal, long&gt;&gt; BeforeInsertAsync(Entity&lt;Animal, long&gt; entity, CancellationToken cancellationToken = default)
    {
        Before++;
        return Task.FromResult(State.Ok(entity));
    }
}
</code></pre>
<p>You have to create the class as public to allow the dependency injection to instastiate it. It's added directly to DI.</p>
<h1 id="factory">Factory</h1>
<p>Integration with factory from rystem is hidden in the framework, and it's ready to be used.
For instance here i'm installing two different repositories for the same model and key.</p>
<pre><code>var builder = WebApplication.CreateBuilder(args);
builder.Services
.AddRepository&lt;SuperUser, string&gt;(settins =&gt;
{
    settins.WithInMemory(builder =&gt;
    {
        builder
            .PopulateWithRandomData(120, 5)
            .WithPattern(x =&gt; x.Value!.Email, @"[a-z]{5,10}@gmail\.com");
    });
    settins.WithInMemory(builder =&gt;
    {
        builder
            .PopulateWithRandomData(2, 5)
            .WithPattern(x =&gt; x.Value!.Email, @"[a-z]{5,10}@gmail\.com");
    }, "inmemory");
});
</code></pre>
<p>Usage</p>
<pre><code>var serviceProvider = ....;
IFactory&lt;IRepository&lt;SuperUser, string&gt;&gt; superUserFactory = serviceProvider.GetRequiredService&lt;IFactory&lt;IRepository&lt;SuperUser, string&gt;&gt;&gt;();
var firstIntegration = superUserFactory.Create();
var secondIntegration = superUserFactory.Create("inmemory");
</code></pre>
<p>By default is injected directly the last one repository integration installed.</p>
<pre><code>var serviceProvider = ....;
IRepository&lt;SuperUser, string&gt; secondIntegration = serviceProvider.GetRequiredService&lt;IRepository&lt;SuperUser, string&gt;&gt;();
</code></pre>
<p>Here you find the "inmemory" integration.
<a href="https://github.com/KeyserDSoze/Rystem/tree/master/src/Core/Rystem">You can use the decorator pattern offered by Rystem</a>
for your integration to decorate an IRepository<T, TKey> or ICommand<T, TKey> or IQuery<T, TKey>.</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Â© 2020</p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
